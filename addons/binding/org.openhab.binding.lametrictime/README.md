# LaMetric Binding

The LaMetric binding allows to connect openHab to LaMetric Time connected clock devices, providing following features:

* Control the LaMetric Time Device
    * Control Display Brightness
    * Change Audio Volume
    * Enable / Disable Bluetooth
    * Activate an Application
* Send notifications messages
* Control the core (built-in) apps
* Push data to private indicator apps

## Supported Things

The device acts as a bridge and is exposed as "LaMetric Time" Thing. The "LaMetric Time" Thing is directly responsible for device operations which include the display, audio, bluetooth, and notifications. All apps are implemented as separate things under the bridge.

| App               | Thing Type   | Description                                                   |
|-------------------|--------------|---------------------------------------------------------------|
| Clock             | clockApp     | Clock that dispays time and date                              |
| Countdown (Timer) | countdownApp | A countdown timer the counts by seconds                       |
| Radio             | radioApp     | Streaming radio player                                        |
| Stopwatch         | stopwatchApp | Stopwatch that counts up by seconds                           |
| Weather           | weatherApp   | Current weather conditions as well as a forecast              |
| Generic (custom)  | genericApp   | Custom apps created by users on the LaMetric developer portal |

## Discovery

The binding supports two levels of discovery - device and apps. Device discovery is accomplished via UPnP. Once a device is added, discovery will find all apps installed on the device and suggest them as individual things with the device being the bridge.

## Binding Configuration

The binding requires no special configuration.

## Thing Configuration

### Bridge (Thing ID: "device")

The bridge requires a host and an API key. The key can be found by visiting <a href="https://developer.lametric.com/user/devices">the LaMetric dev portal</a>.

| Configuration Parameter | Type    | Description                                            | Default | Required |
|-------------------------|---------|--------------------------------------------------------|---------|----------|
| host                    | text    | Host name or network address of the LaMetric Time      |         | Yes      |
| apiKey                  | text    | API key to access LaMetric Time                        |         | Yes      |

### Core (Built-in) Apps (Thing ID: "clockApp", "countdownApp", "radioApp", "stopwatchApp", "weatherApp")

The core app things can be defined with no configuration at all. The package name is defaulted for you. If you do not specify a widget ID, the first available one will be used automatically. Widgets are instances of the application. For example, if you duplicated the weather app for two locations, the app would have two widgets.

| Configuration Parameter | Type    | Description                                                     | Default                   | Required |
|-------------------------|---------|-----------------------------------------------------------------|---------------------------|----------|
| widgetId                | text    | The identifier for the exact instance of the app (widget)       | The first widget ID found | No       |

### Generic (Custom) Apps (Thing ID: "genericApp")

Generic apps are similar to the core apps, but you must supply the package name. If you want to be able to send updates to the app, you must also supply an access token. You can find the access token in the LaMetric dev portal.

| Configuration Parameter | Type    | Description                                                     | Default                   | Required |
|-------------------------|---------|-----------------------------------------------------------------|---------------------------|----------|
| packageName             | text    | The unique package identifier for the app (defined by LaMetric) |                           | Yes      |
| widgetId                | text    | The identifier for the exact instance of the app (widget)       | The first widget ID found | No       |
| accessToken             | text    | The key generated by LaMetric when you created the app          |                           | No       |

### Sample Thing Configuration

```
Bridge lametrictime:device:demo [ host="somehost", apiKey="ksfjsdkfsksjfs" ]
{
    Thing clockApp     clock       [ widgetId="generatedcorewidgetid1" ]
    Thing countdownApp countdown
    Thing radioApp     radio
    Thing stopwatchApp stopwatch
    Thing weatherApp   weather     [ widgetId="generatedcorewidgetid2" ]
    Thing genericApp   myApp       [ packageName="com.lametric.generatedpackagename1", widgetId="generatedwidgetid1", accessToken="generatedaccesstoken" ]
    Thing genericApp   someonesApp [ packageName="com.lametric.generatedpackagename2", widgetId="generatedwidgetid2" ]
}
```

## Channels

### Device

| Channel ID     | Item Type                                        | Description                                                                                                                                                                                                           |
|----------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| brightness     | Dimmer                                           | The brightness of the display. Please note that changing the brightness will automatically set the 'brightnessMode' to 'manual'.                                                                                      |
| brightnessMode | String (possible values are 'auto' and 'manual') | The mode for the display brightness. If set to 'auto' the brightness is set by the device automatically based on environment illumination. If set to 'manual' the brightness can be changed via 'brightness' channel. |
| volume         | Dimmer                                           | The volume of the device speaker.                                                                                                                                                                                     |
| bluetooth      | Switch                                           | The status of Bluetooth audio streaming on the device.                                                                                                                                                                |
| app            | String                                           | The active application on the device. State options for UIs are determined at runtime automatically. The value must be formatted as '<package name>:<widget ID>'.                                                     |
| info           | String                                           | Send informational notifications to the device.                                                                                                                                                                       |
| warning        | String                                           | Send warning notifications to the device.                                                                                                                                                                             |
| alert          | String                                           | Send alert notifications to the device.                                                                                                                                                                               |
| advanced       | String                                           | Send a complete custom notification. See below for details.                                                                                                                                                           |


### Clock App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                                         |
|------------|-----------|---------------------------------------------------------------------|
| setAlarm   | DateTime  | Set the alarm using the given time (note that the date is not used) |
| stopAlarm  | Switch    | Stop the alarm (currently not working)                              |

### Countdown App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                  |
|------------|-----------|----------------------------------------------|
| duration   | Number    | Set the duration of the countdown in seconds |
| pause      | Switch    | Pause the active countdown                   |
| reset      | Switch    | Stop and reset the countdown                 |
| start      | Switch    | Start the countdown                          |

### Radio App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                           |
|------------|-----------|-------------------------------------------------------|
| control    | Player    | Control interface to manipulate the radio             |

### Stopwatch App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                   |
|------------|-----------|-------------------------------|
| pause      | Switch    | Pause the active stopwatch    |
| reset      | Switch    | Stop and reset the stopwatch  |
| start      | Switch    | Start the stopwatch           |

### Weather App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                      |
|------------|-----------|----------------------------------|
| forecast   | Switch    | Display the forecast temporarily |

### Generic App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                                                |
|------------|-----------|----------------------------------------------------------------------------|
| frames     | String    | Set a JSON string that represents the updated frames to display in the app |

## How Tos

The following configuration examples assume the device was added with the thing id `lametrictime:clock:8d0f3b8e`. Replace the thing id in all the configurations with your real thing id which can be looked up via paper UI.


### Notifications

#### Simple text notifications

The binding provides three simple notification channels for 

* info messages: `lametrictime:clock:8d0f3b8e:info`
* warning messages: `lametrictime:clock:8d0f3b8e:warning`
* alert messages: `lametrictime:clock:8d0f3b8e:alert`

To post messages to these channels, simply map them to a String item. For example like this:

```
String LametricInfoNotification "Info Message" {channel="lametrictime:clock:8d0f3b8e:info"}
```

By setting a text on the item, the binding will send the notification which is displays on the LaMetric device. 

In a rule this could be done the following way:

``` 
sendCommand(LametricInfoNotification, "My Information Message to be displayed")
```

#### Advanced notifications

In case the simple channels do no satisfy your needs, for example if you need to send different of multiple frames in a notification, the advanced channel exists, which allows sending the full JSON data structure as documented on <a href="http://lametric-documentation.readthedocs.io/en/latest/reference-docs/device-notifications.html">http://lametric-documentation.readthedocs.io/en/latest/reference-docs/device-notifications.html</a> in the POST section.
 
For example following message could be sent to the advanced channel.

```json
{
    "priority": "critical",
    "model": {
        "cycles": 1,
        "frames": [
        {
            "icon": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAUklEQVQYlWNUVFBgYGBgYBC98uE/AxJ4rSPAyMDAwMCETRJZjAnGgOlAZote+fCfCV0nOmA0+yKAYTwygJuAzQoGBgYGRkUFBQZ0dyDzGQl5EwCTESNpFb6zEwAAAABJRU5ErkJggg==",
            "text": "HELLO!"
        }],
        "sound": {
            "category": "notifications",
            "id": "cat"
        }
    }
}
```

### Indicator Apps

Custom Indicator Apps can be served with data in the local network. To do this, you have first to create an Indicator App on <a href="https://developer.lametric.com">https://developer.lametric.com</a>. 

1. Sign in an press the "Create" Button
2. Choose "Create" below the "Indicator App" section.
3. Add the desired frames.
4. Choose "Push" in the "Communication type" section (__Importatant!__ the binding just supports Push, no Pull)
5. Give it a name and description and Save it ( check "private app" )

After this, the app should be available under "My Apps" on https://developer.lametric.com. There you will find the later required information. In particular you will need:

 * The package name of the application 
   * This can be extracted from the "Local Push URL" field. If for example the URL is  `https://192.168.1.202:4343/api/v1/dev/widget/update/com.lametric.488e77ba30798ff12674b2df930382ef/1`, the id is the part after `update/`and before `/1`. So in the example here it would be `com.lametric.488e77ba30798ff12674b2df930382ef`. 
 * The access token
 * The data format

#### Item mapping

Indicator Apps can be served with data by setting a JSON formatted string on a text item which is mapped to the `indicatorApp` channel

```
String LametricIndicatorApp "IndicatorApp" { channel="lametrictime:genericApp:demo:myApp:frames" }
```

#### JSON Data format

The text item can be set to a JSON formatted string for the apps frame like the following.

```json
{ "frames" : [
         {
            "icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAUklEQVQYlWNUVFBgYGBgYBC98uE/AxJ4rSPAyMDAwMCETRJZjAnGgOlAZote+fCfCV0nOmA0+yKAYTwygJuAzQoGBgYGRkUFBQZ0dyDzGQl5EwCTESNpFb6zEwAAAABJRU5ErkJggg==",
            "text":"Hello dude!"
         },
         {
           "icon":"i120",
           "goalData":{
             "start": 0,
             "current": 77,
             "end": 100,
             "unit": "%"
            }
         },
         {
            "chartData": [ 1, 2, 3, 4, 5, 6, 7 ]
         }
    ]}
```

See below for examples rules sending updates for the frames.
 
## Items
 
Sample item configuration:
 
```
Dimmer DeviceBrightness         "Brightness"                                { channel="lametrictime:device:demo:brightness" }
String DeviceBrightnessMode     "Brightness Mode"                           { channel="lametrictime:device:demo:brightnessMode" }
Dimmer DeviceVolume             "Volume"                   <soundvolume>    { channel="lametrictime:device:demo:volume" }
Switch DeviceBluetooth          "Bluetooth"                                 { channel="lametrictime:device:demo:bluetooth" }
String DeviceApp                "Application"                               { channel="lametrictime:device:demo:app" }

String DeviceNotifyInfo                                                     { channel="lametrictime:device:demo:info" }
String DeviceNotifyWarning                                                  { channel="lametrictime:device:demo:warning" }
String DeviceNotifyAlert                                                    { channel="lametrictime:device:demo:alert" }
String DeviceNotifyAdvanced                                                 { channel="lametrictime:device:demo:advanced" }
Switch NotifyInfo               "Notify Info"
Switch NotifyWarning            "Notify Warning"
Switch NotifyAlert              "Notify Alert"
Switch NotifyTheRoofIsOnFire    "The Roof Is On Fire!"

DateTime ClockSetAlarm          "Set Alarm"                                 { channel="lametrictime:clockApp:demo:clock:setAlarm" }
Switch   ClockStopAlarm         "Stop Alarm"                                { channel="lametrictime:clockApp:demo:clock:stopAlarm" }
Switch   SetAlarmIn1Min         "Set Alarm in 1 min"

Number CountdownDuration        "Countdown Duration"                        { channel="lametrictime:countdownApp:demo:countdown:duration" }
Switch CountdownPause           "Pause Countdown"                           { channel="lametrictime:countdownApp:demo:countdown:pause" }
Switch CountdownReset           "Reset Countdown"                           { channel="lametrictime:countdownApp:demo:countdown:reset" }
Switch CountdownStart           "Start Countdown"                           { channel="lametrictime:countdownApp:demo:countdown:start" }
Switch Set2MinCountdown         "Set 2 Min Countdown"

Player RadioControl             "Player"                                    { channel="lametrictime:radioApp:demo:radio:control" }

Switch StopwatchPause           "Pause Stopwatch"                           { channel="lametrictime:stopwatchApp:demo:stopwatch:pause" }
Switch StopwatchReset           "Reset Stopwatch"                           { channel="lametrictime:stopwatchApp:demo:stopwatch:reset" }
Switch StopwatchStart           "Start Stopwatch"                           { channel="lametrictime:stopwatchApp:demo:stopwatch:start" }

Switch WeatherForecast          "Forecast Weather"                          { channel="lametrictime:weatherApp:demo:weather:forecast" }

String TestAppFrames                                                        { channel="lametrictime:genericApp:demo:test:frames" }
Switch UpdateTestApp            "Update Test App"
```

## Sitemap

Sample sitemap configuration:

**Note:** Populating switch or selection options automatically from the state description is not currently possible with sitemaps. For this reason, the brightness modes and example applications are repeated here.

```
        Text label="LaMetric Time Demo" {
            Frame label="Device Controls" {
                Slider item=DeviceBrightness
                Switch item=DeviceBrightnessMode mappings=[AUTO="Automatic",MANUAL="Manual"]
                Slider item=DeviceVolume
                Switch item=DeviceBluetooth
                Selection item=DeviceApp mappings=["com.lametric.clock:widgetid"="Clock","com.lametric.countdown:widgetid"="Timer"]
            }
            Frame label="Device Notifications" {
                Switch item=NotifyInfo
                Switch item=NotifyWarning
                Switch item=NotifyAlert
                Switch item=NotifyTheRoofIsOnFire
            }
            Frame label="Clock" {
                Switch item=SetAlarmIn1Min
                Switch item=ClockStopAlarm            
            }
            Frame label="Countdown" {
                Switch item=Set2MinCountdown
                Switch item=CountdownPause
                Switch item=CountdownReset
                Switch item=CountdownStart             
            }
            Frame label="Radio" {
                Default item=RadioControl
            }
            Frame label="Stopwatch" {
                Switch item=StopwatchPause
                Switch item=StopwatchReset
                Switch item=StopwatchStart
            }
            Frame label="Weather" {
                Switch item=WeatherForecast
            }
            Frame label="Test App" {
                Switch item=UpdateTestApp            
            }
        }
```

## Rules

Sample rules:

```
import java.util.Calendar

rule "Notify Info"
    when
        Item NotifyInfo changed to ON
    then
        postUpdate(NotifyInfo, OFF)
        
        logInfo("demo.rules", "Sending info notification")
        sendCommand(DeviceNotifyInfo, "INFO!")
end

rule "Notify Warning"
    when
        Item NotifyWarning changed to ON
    then
        postUpdate(NotifyWarning, OFF)
        
        logInfo("demo.rules", "Sending warning notification")
        sendCommand(DeviceNotifyWarning, "WARNING!")
end

rule "Notify Alert"
    when
        Item NotifyAlert changed to ON
    then
        postUpdate(NotifyAlert, OFF)
        
        logInfo("demo.rules", "Sending alert notification")
        sendCommand(DeviceNotifyAlert, "ALERT!")
end

rule "Notify The Roof Is On Fire"
    when
        Item NotifyTheRoofIsOnFire changed to ON
    then
        postUpdate(NotifyTheRoofIsOnFire, OFF)
        
        logInfo("demo.rules", "Sending the roof is on fire!")
        val jsonMessage = String::format('{
                "priority": "critical",
                "model": {
                    "cycles": 1,
                    "frames": [
                    {
                        "icon": "a2867",
                        "text": "The roof, the roof, the roof is on fire!"
                    }],
                    "sound": {
                        "category": "notifications",
                        "id": "energy",
                        "repeat": 2
                    }
                }
            }')
             
        sendCommand(DeviceNotifyAdvanced, jsonMessage)
end

rule "Set Alarm in 1 Minute"
    when
         Item SetAlarmIn1Min changed to ON
    then
         postUpdate(SetAlarmIn1Min, OFF)
         
         logInfo("demo.rules", "Setting alarm for 1 minute from now")
         
         val cal = Calendar.getInstance()
         cal.add(Calendar.MINUTE, 1)
         sendCommand(ClockSetAlarm, new DateTimeType(cal))
end

rule "Set 2 Minute Countdown"
    when
         Item Set2MinCountdown changed to ON
    then
         postUpdate(Set2MinCountdown, OFF)
         
         logInfo("demo.rules", "Configure countdown for 2 minutes without starting")
         sendCommand(CountdownDuration, 120)
end

rule "Update Test App"
    when
         Item UpdateTestApp changed to ON
    then
         postUpdate(UpdateTestApp, OFF)
         
         logInfo("demo.rules", "Building test app update message")
         val jsonMessage = String::format('{
                   "frames" : [
                     {
                        "text": "62°",
                        "icon": "i120",
                        "index": 0
                     }
                   ]
                 }')
    
         logInfo("demo.rules", "Sending test app update")
         sendCommand(TestAppFrames, jsonMessage)
end

rule "update indicator app with temperatures"
when
    Item OutsideTemp received update or
    Item InsideTemp received update
 then
 
     val insideTemp = (InsideTemp.state as DecimalType).floatValue
     val outsideTemp = (OutsideTemp.state as DecimalType).floatValue
     
     val jsonMessage = String::format('{    
        "frames" : [
             {
                "icon":"i4286",
                "text":"%1$.1f °C"
             },
             {
                "icon":"i4285",
                "text":"%2$.1f °C"
             }
        ]
      }', insideTemp, outsideTemp )

 sendCommand(LametricIndicatorApp, jsonMessage)
 
 end
```
