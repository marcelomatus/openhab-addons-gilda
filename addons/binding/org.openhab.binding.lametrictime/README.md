# LaMetric Binding

The LaMetric binding allows to connect openHab to LaMetric Time connected clock devices, providing following features:

* Control the LaMetric Time Device
    * Control Display Brightness
    * Change Audio Volume
    * Enable / Disable Bluetooth
* Send notifications messages
* Control the core (built-in) apps
* Push data to private indicator apps

## Supported Things

The device acts as a bridge and is exposed as "LaMetric Time" Thing. The "LaMetric Time" Thing is directly responsible for device operations which include the display, audio, bluetooth, and notifications. All apps are implemented as separate things under the bridge.

| App               | Thing Type   | Description                                                   |
|-------------------|--------------|---------------------------------------------------------------|
| Clock             | clockApp     | Clock that dispays time and date                              |
| Countdown (Timer) | countdownApp | A countdown timer the counts by seconds                       |
| Radio             | radioApp     | Streaming radio player                                        |
| Stopwatch         | stopwatchApp | Stopwatch that counts up by seconds                           |
| Weather           | weatherApp   | Current weather conditions as well as a forecast              |
| Generic (custom)  | genericApp   | Custom apps created by users on the LaMetric developer portal |

## Discovery

TODO

## Binding Configuration

The binding requires no special configuration.

## Thing Configuration

### Bridge (Thing ID: "device")

The bridge requires a host and an API key. The key can be found by visiting <a href="https://developer.lametric.com/user/devices">the LaMetric dev portal</a>. Optionally, you can also enable logging.

| Configuration Parameter | Type    | Description                                            | Default |
|-------------------------|---------|--------------------------------------------------------|---------|
| host                    | text    | Host name or network address of the LaMetric Time      |         |
| apiKey                  | text    | API key to access LaMetric Time                        |         |
| logging                 | boolean | Enables or disables logging in the LaMetric Time API   | false   |

### Core (Built-in) Apps (Thing ID: "clockApp", "countdownApp", "radioApp", "stopwatchApp", "weatherApp")

The core app things can be defined with no configuration at all. The package name is defaulted for you. If you do not specify a widget ID, the first available one will be used automatically. Widgets are instances of the application. For example, if you duplicated the weather app for two locations, the app would have two widgets.

| Configuration Parameter | Type    | Description                                                     | Default                   |
|-------------------------|---------|-----------------------------------------------------------------|---------------------------|
| packageName             | text    | The unique package identifier for the app (defined by LaMetric) | The name of the app       |
| widgetId                | text    | The identifier for the exact instance of the app  (widget)      | The first widget ID found |

### Generic (Custom) Apps (Thing ID: "genericApp")

Generic apps are similar to the core apps, but you must suppy the package name. If you want to be able to send updates to the app, you must also supply an access token. You can find the access token in the LaMetric dev portal.

| Configuration Parameter | Type    | Description                                                     | Default                   |
|-------------------------|---------|-----------------------------------------------------------------|---------------------------|
| packageName             | text    | The unique package identifier for the app (defined by LaMetric) |                           |
| widgetId                | text    | The identifier for the exact instance of the app  (widget)      | The first widget ID found |
| accessToken             | text    | The key generated by LaMetric when you created the app          |                           |

### Sample Thing Configuration

```
Bridge lametrictime:device:demo [ host="somehost", apiKey="ksfjsdkfsksjfs", logging=true ]
{
    Thing clockApp     clock       [ widgetId="generatedcorewidgetid1" ]
    Thing countdownApp countdown
    Thing radioApp     radio
    Thing stopwatchApp stopwatch
    Thing weatherApp   weather     [ widgetId="generatedcorewidgetid2" ]
    Thing genericApp   myApp       [ packageName="com.lametric.generatedpackagename1", widgetId="generatedwidgetid1", accessToken="generatedaccesstoken" ]
    Thing genericApp   someonesApp [ packageName="com.lametric.generatedpackagename2", widgetId="generatedwidgetid2" ]
}
```

## Channels

### Device

| Channel ID             | Item Type                                        | Description                                                                                                                     |
|------------------------|--------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| display#brightness     | Dimmer                                           | The brightness of the display. Please note that changing the brightness will automatically set the 'brightnessMode' to 'manual' |
| display#brightnessMode | String (possible values are 'auto' and 'manual') | The mode for the display brightness. If set to 'auto' the brightness is set by the device automatically based on environment illumination. If set to 'manual' the brightness can be changed via 'brightness' channel. |
| audio#volum            | Dimmer                                           | The volume of the device speaker.                                                         |
| bluetooth#active       | Switch                                           | Allows to enable or disable the bluetooth interface of the device.                        |
| bluetooth#name         | String                                           | Name of the bluetooth connection. This channel allows to read and also change the name.   |
| bluetooth#discoverable | Switch                                           | indicates if the bluetooth is discoverable.                                               |
| bluetooth#available    | Switch (read only)                               | indicates if the bluetooth is available.                                                  |
| bluetooth#mac          | String (read only)                               | Allows to read the MAC address of the bluetooth interface.                                |
| notifications#info     | String                                           | Allows to send info notifications to the device.                                          |
| notifications#warning  | String                                           | Allows to send warning notifications to the device.                                       |
| notifications#alert    | String                                           | Allows to send alert notifications to the device.                                         |
| notifications#advanced | String                                           | Allows to send a complete custom notification. See below for details                      |


### Clock App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                                                                                |
|------------|-----------|------------------------------------------------------------------------------------------------------------|
| activate   | Switch    | Activate the defined instance                                                                              |
| setAlarm   | String    | Set a JSON string that represents the parameters to set an alarm (enabled, time, wakeOnRadio)              |
| snooze     | String    | Set a JSON string that represents the parameters to snooze an alarm (amount, unit) (currently not working) |
| snooze10   | Switch    | Snooze the alarm for 10 minutes (currently not working)                                                    |
| stopAlarm  | Switch    | Stop the alarm (currently not working)                                                                     |

### Countdown App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                                                                 |
|------------|-----------|---------------------------------------------------------------------------------------------|
| activate   | Switch    | Activate the defined instance                                                               |
| configure  | String    | Set a JSON string that represents the parameters to configure the time (duration, startNow) |
| pause      | Switch    | Pause the active countdown                                                                  |
| reset      | Switch    | Stop and reset the countdown                                                                |
| start      | Switch    | Start the countdown                                                                         |

### Radio App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                           |
|------------|-----------|-------------------------------------------------------|
| activate   | Switch    | Activate the defined instance                         |
| next       | Switch    | Change to the next defined stream                     |
| play       | Switch    | Play the current stream                               |
| previous   | Switch    | Change to the previous stream (currently not working) |
| stop       | Switch    | Stop the radio                                        |
| control    | Player    | Control interface to manipulate the radio             |

### Stopwatch App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                   |
|------------|-----------|-------------------------------|
| activate   | Switch    | Activate the defined instance |
| pause      | Switch    | Pause the active stopwatch    |
| reset      | Switch    | Stop and reset the stopwatch  |
| start      | Switch    | Start the stopwatch           |

### Weather App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                      |
|------------|-----------|----------------------------------|
| activate   | Switch    | Activate the defined instance    |
| forecast   | Switch    | Display the forecast temporarily |

### Generic App

All channels have no defined state. They exist as one-way communication to the device. This means that a switch that is "ON" has no more meaning than one that is "OFF".

| Channel ID | Item Type | Description                                                                |
|------------|-----------|----------------------------------------------------------------------------|
| activate   | Switch    | Activate the defined instance                                              |
| frames     | String    | Set a JSON string that represents the updated frames to display in the app |

## How Tos

The following configuration examples assume the device was added with the thing id `lametrictime:clock:8d0f3b8e`. Replace the thing id in all the configurations with your real thing id which can be looked up via paper UI.


### Notifications

#### Simple text notifications

The binding provides three simple notification channels for 

* info messages: `lametrictime:clock:8d0f3b8e:notifications#info`
* warning messages: `lametrictime:clock:8d0f3b8e:notifications#warning`
* alert messages: `lametrictime:clock:8d0f3b8e:notifications#alert`

To post messages to these channels, simply map them to a String item. For example like this:

```
String LametricInfoNotification "Info Message" {channel="lametrictime:clock:8d0f3b8e:notifications#info"}
```

By setting a text on the item, the binding will send the notification which is displays on the LaMetric device. 

In a rule this could be done the following way:

``` 
sendCommand(LametricInfoNotification, "My Information Message to be displayed")
```

#### Advanced notifications

In case the simple channels do no satisfy your needs, for example if you need to send different of multiple frames in a notification, the advanced channel exists, which allows sending the full JSON data structure as documented on <a href="http://lametric-documentation.readthedocs.io/en/latest/reference-docs/device-notifications.html">http://lametric-documentation.readthedocs.io/en/latest/reference-docs/device-notifications.html</a> in the POST section.
 
For example following message could be sent to the advanced channel.

```json
{
    "priority": "critical",
    "model": {
        "cycles": 1,
        "frames": [
        {
            "icon": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAUklEQVQYlWNUVFBgYGBgYBC98uE/AxJ4rSPAyMDAwMCETRJZjAnGgOlAZote+fCfCV0nOmA0+yKAYTwygJuAzQoGBgYGRkUFBQZ0dyDzGQl5EwCTESNpFb6zEwAAAABJRU5ErkJggg==",
            "text": "HELLO!"
        }],
        "sound": {
            "category": "notifications",
            "id": "cat"
        }
    }
}
```

### Indicator Apps

Custom Indicator Apps can be served with data in the local network. To do this, you have first to create an Indicator App on <a href="https://developer.lametric.com">https://developer.lametric.com</a>. 

1. Sign in an press the "Create" Button
2. Choose "Create" below the "Indicator App" section.
3. Add the desired frames.
4. Choose "Push" in the "Communication type" section (__Importatant!__ the binding just supports Push, no Pull)
5. Give it a name and description and Save it ( check "private app" )

After this, the app should be available under "My Apps" on https://developer.lametric.com. There you will find the later required information. In particular you will need:

 * The package name of the application 
   * This can be extracted from the "Local Push URL" field. If for example the URL is  `https://192.168.1.202:4343/api/v1/dev/widget/update/com.lametric.488e77ba30798ff12674b2df930382ef/1`, the id is the part after `update/`and before `/1`. So in the example here it would be `com.lametric.488e77ba30798ff12674b2df930382ef`. 
 * The access token
 * The data format

#### Item mapping

Indicator Apps can be served with data by setting a JSON formatted string on a text item which is mapped to the `indicatorApp` channel

```
String LametricIndicatorApp "IndicatorApp" { channel="lametrictime:genericApp:demo:myApp:frames" }
```

#### JSON Data format

The text item can be set to a JSON formatted string for the apps frame like the following.

```json
{ "frames" : [
         {
            "icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAUklEQVQYlWNUVFBgYGBgYBC98uE/AxJ4rSPAyMDAwMCETRJZjAnGgOlAZote+fCfCV0nOmA0+yKAYTwygJuAzQoGBgYGRkUFBQZ0dyDzGQl5EwCTESNpFb6zEwAAAABJRU5ErkJggg==",
            "text":"Hello dude!"
         },
         {
           "icon":"i120",
           "goalData":{
             "start": 0,
             "current": 77,
             "end": 100,
             "unit": "%"
            }
         },
         {
            "chartData": [ 1, 2, 3, 4, 5, 6, 7 ]
         }
    ]}
```

See below for examples rules sending updates for the frames.
 
## Items
 
Sample item configuration:
 
```
Dimmer DeviceDisplayBrightness  "Brightness"               { channel="lametrictime:device:demo:display#brightness" }
String DeviceDisplayBrightMode  "Brightness Mode"          { channel="lametrictime:device:demo:display#brightnessMode" }

Dimmer DeviceAudioVolume        "Volume"                   { channel="lametrictime:device:demo:audio#volume" }

Switch DeviceBTActive           "Active"                   { channel="lametrictime:device:demo:bluetooth#active" }
String DeviceBTName             "Name [%s]"                { channel="lametrictime:device:demo:bluetooth#name" }
Switch DeviceBTDiscoverable     "Discoverable [%s]"        { channel="lametrictime:device:demo:bluetooth#discoverable" }
Switch DeviceBTAvailable        "Available [%s]"           { channel="lametrictime:device:demo:bluetooth#available" }
Switch DeviceBTPairable         "Pairable [%s]"            { channel="lametrictime:device:demo:bluetooth#pairable" }
String DeviceBTMac              "MAC [%s]"                 { channel="lametrictime:device:demo:bluetooth#mac" }

String DeviceNotifyInfo                                    { channel="lametrictime:device:demo:notifications#info" }
String DeviceNotifyWarning                                 { channel="lametrictime:device:demo:notifications#warning" }
String DeviceNotifyAlert                                   { channel="lametrictime:device:demo:notifications#alert" }
String DeviceNotifyAdvanced                                { channel="lametrictime:device:demo:notifications#advanced" }
Switch NotifyInfo               "Notify Info"
Switch NotifyWarning            "Notify Warning"
Switch NotifyAlert              "Notify Alert"
Switch NotifyTheRoofIsOnFire    "The Roof Is On Fire!"

Switch ClockActivate            "Activate Clock"           { channel="lametrictime:clockApp:demo:clock:activate" }
String ClockSetAlarm                                       { channel="lametrictime:clockApp:demo:clock:setAlarm" }
String ClockSnooze                                         { channel="lametrictime:clockApp:demo:clock:snooze" }
Switch ClockSnooze10            "Snooze 10 Min"            { channel="lametrictime:clockApp:demo:clock:snooze10" }
Switch ClockStopAlarm           "Stop Alarm"               { channel="lametrictime:clockApp:demo:clock:stopAlarm" }
Switch SetAlarmIn1Min           "Set Alarm in 1 min"

Switch CountdownActivate        "Activate Countdown"       { channel="lametrictime:countdownApp:demo:countdown:activate" }
String CountdownConfigure                                  { channel="lametrictime:countdownApp:demo:countdown:configure" }
Switch CountdownPause           "Pause Countdown"          { channel="lametrictime:countdownApp:demo:countdown:pause" }
Switch CountdownReset           "Reset Countdown"          { channel="lametrictime:countdownApp:demo:countdown:reset" }
Switch CountdownStart           "Start Countdown"          { channel="lametrictime:countdownApp:demo:countdown:start" }
Switch Set2MinCountdown         "Set 2 Min Countdown"

Switch RadioActivate            "Activate Radio"           { channel="lametrictime:radioApp:demo:radio:activate" }
Switch RadioNext                "Next Station"             { channel="lametrictime:radioApp:demo:radio:next" }
Switch RadioPlay                "Play Radio"               { channel="lametrictime:radioApp:demo:radio:play" }
Switch RadioPrevious            "Previous Station"         { channel="lametrictime:radioApp:demo:radio:previous" }
Switch RadioStop                "Stop Radio"               { channel="lametrictime:radioApp:demo:radio:stop" }
Player RadioControl             "Player"                   { channel="lametrictime:radioApp:demo:radio:control" }

Switch StopwatchActivate        "Activate Stopwatch"       { channel="lametrictime:stopwatchApp:demo:stopwatch:activate" }
Switch StopwatchPause           "Pause Stopwatch"          { channel="lametrictime:stopwatchApp:demo:stopwatch:pause" }
Switch StopwatchReset           "Reset Stopwatch"          { channel="lametrictime:stopwatchApp:demo:stopwatch:reset" }
Switch StopwatchStart           "Start Stopwatch"          { channel="lametrictime:stopwatchApp:demo:stopwatch:start" }

Switch WeatherActivate          "Activate Weather"         { channel="lametrictime:weatherApp:demo:weather:activate" }
Switch WeatherForecast          "Forecast Weather"         { channel="lametrictime:weatherApp:demo:weather:forecast" }

Switch TestAppActivate          "Activate Test"            { channel="lametrictime:genericApp:demo:myApp:activate" }
String TestAppFrames                                       { channel="lametrictime:genericApp:demo:myApp:frames" }
Switch UpdateTestApp            "Update Test App"
```

## Sitemap

Sample sitemap configuration:

```
        Text label="LaMetric Time Demo" {
            Frame label="Device Display" {
                Slider item=DeviceDisplayBrightness
                Switch item=DeviceDisplayBrightMode mappings=[AUTO="Auto",MANUAL="Manual"]
            }
            Frame label="Device Audio" {
                Slider item=DeviceAudioVolume
            }
            Frame label="Device Bluetooth" {
                Switch item=DeviceBTActive
                Text item=DeviceBTName
                Switch item=DeviceBTDiscoverable
                Switch item=DeviceBTAvailable
                Switch item=DeviceBTPairable
                Text item=DeviceBTMac
            }
            Frame label="Device Notifications" {
                Switch item=NotifyInfo
                Switch item=NotifyWarning
                Switch item=NotifyAlert
                Switch item=NotifyTheRoofIsOnFire
            }
            Frame label="Clock" {
                Switch item=ClockActivate
                Switch item=SetAlarmIn1Min
                Switch item=ClockSnooze10
                Switch item=ClockStopAlarm            
            }
            Frame label="Countdown" {
                Switch item=CountdownActivate
                Switch item=Set2MinCountdown
                Switch item=CountdownPause
                Switch item=CountdownReset
                Switch item=CountdownStart             
            }
            Frame label="Radio" {
                Switch item=RadioActivate
                Switch item=RadioNext
                Switch item=RadioPlay
                Switch item=RadioPrevious
                Switch item=RadioStop
                Default item=RadioControl
            }
            Frame label="Stopwatch" {
                Switch item=StopwatchActivate
                Switch item=StopwatchPause
                Switch item=StopwatchReset
                Switch item=StopwatchStart
            }
            Frame label="Weather" {
                Switch item=WeatherActivate
                Switch item=WeatherForecast
            }
            Frame label="Test App" {
                Switch item=TestAppActivate
                Switch item=UpdateTestApp            
            }
        }
```

## Rules

Sample rules:

```
rule "Notify Info"
    when
        Item NotifyInfo changed to ON
    then
        postUpdate(NotifyInfo, OFF)
        
        logInfo("demo.rules", "Sending info notification")
        sendCommand(DeviceNotifyInfo, "INFO!")
end

rule "Notify Warning"
    when
        Item NotifyWarning changed to ON
    then
        postUpdate(NotifyWarning, OFF)
        
        logInfo("demo.rules", "Sending warning notification")
        sendCommand(DeviceNotifyWarning, "WARNING!")
end

rule "Notify Alert"
    when
        Item NotifyAlert changed to ON
    then
        postUpdate(NotifyAlert, OFF)
        
        logInfo("demo.rules", "Sending alert notification")
        sendCommand(DeviceNotifyAlert, "ALERT!")
end

rule "Notify The Roof Is On Fire"
    when
        Item NotifyTheRoofIsOnFire changed to ON
    then
        postUpdate(NotifyTheRoofIsOnFire, OFF)
        
        logInfo("demo.rules", "Sending the roof is on fire!")
        val jsonMessage = String::format('{
                "priority": "critical",
                "model": {
                    "cycles": 1,
                    "frames": [
                    {
                        "icon": "a2867",
                        "text": "The roof, the roof, the roof is on fire!"
                    }],
                    "sound": {
                        "category": "notifications",
                        "id": "energy",
                        "repeat": 2
                    }
                }
            }')
             
        sendCommand(DeviceNotifyAdvanced, jsonMessage)
end

rule "Set Alarm in 1 Minute"
    when
         Item SetAlarmIn1Min changed to ON
    then
         postUpdate(SetAlarmIn1Min, OFF)
         
         logInfo("demo.rules", "Setting alarm for 1 minute from now")
         
         val time = java.time.LocalTime.now().plusMinutes(1)
         val jsonMessage = String::format('{
                   "enabled": true,
                   "time": "%1$s",
                   "wakeWithRadio": false
                 }', time)
    
         logInfo("demo.rules", "Setting alarm for " + time)
         sendCommand(ClockSetAlarm, jsonMessage)
end

rule "Set 2 Minute Countdown"
    when
         Item Set2MinCountdown changed to ON
    then
         postUpdate(Set2MinCountdown, OFF)
         
         logInfo("demo.rules", "Configure countdown for 2 minutes without starting")
         
         val jsonMessage = String::format('{
                   "duration": 120,
                   "startNow": false
                 }')
    
         sendCommand(CountdownConfigure, jsonMessage)
end

rule "Update Test App"
    when
         Item UpdateTestApp changed to ON
    then
         postUpdate(UpdateTestApp, OFF)
         
         logInfo("demo.rules", "Building test app update message")
         val jsonMessage = String::format('{
                   "frames" : [
                     {
                        "text": "62°",
                        "icon": "i120",
                        "index": 0
                     }
                   ]
                 }')
    
         logInfo("demo.rules", "Sending test app update")
         sendCommand(TestAppFrames, jsonMessage)
end

rule "update indicator app with temperatures"
when
    Item OutsideTemp received update or
    Item InsideTemp received update
 then
 
     val insideTemp = (InsideTemp.state as DecimalType).floatValue
     val outsideTemp = (OutsideTemp.state as DecimalType).floatValue
     
     val jsonMessage = String::format('{    
        "frames" : [
             {
                "icon":"i4286",
                "text":"%1$.1f °C"
             },
             {
                "icon":"i4285",
                "text":"%2$.1f °C"
             }
        ]
      }', insideTemp, outsideTemp )

 sendCommand(LametricIndicatorApp, jsonMessage)
 
 end
```
