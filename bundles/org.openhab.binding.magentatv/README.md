# MagentaTV Binding

This Binding allows controlling the Deutsche Telekom Magenta TV Media Receiver series MR4xx and MR2xx (Telekom NGTV / Huawei Envision platform). 
The Binding does NOT support MR3xx/1xx (old Entertain system based on Microsoft technology)!

Media Receivers are automatically discovered.
You could send keys as you press them on the remote and the binding receives program information when the channel is switched (no
The binding provides device discovery, sending keys for the remote and also receiving program information/events.

## Supported Things

|Thing    |Type                                                                    |
|---------|----------------------------------------------------------------------- |
|receiver |A MagentaTV Receiver, the binding supports multiple models (see above). |

### Supported Models

* Deutsche Telekom Media Receiver MR401B - fully supported
* Deutsche Telekom Media Receiver MR201  - fully supported
* Deutsche Telekom Media Receiver MR400  - supported with minor restrictions (POWER key)
* Deutsche Telekom Media Receiver MR200  - supported with minor restrictions (POWER key)
* Deutsche Telekom Media Receiver MR601  - should be supported (not verified)
* Deutsche Telekom Media Receiver MR3xx  - NOT supported (different platform)
* Deutsche Telekom Media Receiver MR1xx  - NOT supported (different platform)

## Auto Discovery

UPnP will be used to discover receivers on the local network and discover the nessesary parameters.
The receiver needs to be powered on to get discovered.

Once the receiver is discovered it can be added from the Inbox.
Make sure to set the parameter `userId` in the Thing configuration after adding the new thing, see section Thing Configuration.

Note:
The binding uses the network settings in openHAB's system configuration to determine the local IP address.
The device can't be discovered if the openHAB system and receiver are not on the same network (IP/Netmask).
In this case you need to add the Thing manually or use textual configuration (.things).

If you are running openHAB in a Docker container you need to make sure that UPnP discovery is available and network interfaces 

## Generating the UID (`userId`)

The binding requires a so called UID (`userId`) to pair with the receiver, which is generated by logging in with your Telekom credentials (Login Name + Password for the "Telekom Kundencenter").
openHAB needs to access the Internet to perform that operation, which can be disabled afterwards.

The binding initiates the pairing with the receiver once the userId has been obtained, this is an automated process.
The Thing changes to ONLINE once the pairing result is received, otherwise check the Thing status for an error message.

There are different ways to setup the userId:

1. Use the openHAB console
Run the following command on the console and provide your Tesla account credentials (the same that you use in the official Tesla app):

```
openhab> smarthome:magentatv login
Username (email): mail@example.com
Password: topsecret

Attempting login...
Login successful, returned UID (userId) is 1903AAAAAAAAC7E9718BBBCBCBCBCBC
Edit thing configuration and copy this value to the field UID
```

On successful login the console will show the userId value. Copy&amp;Paste this value to the Thing configuration (parameter UID / `userId`) of the receiver.
If you have multiple receivers under the same MagentaTV subscription you could re-use this value for the other receiver Things. 

2. Provide your credentials in the UI
If you do not want to use the openHAB console, you can also setup the credentials in the Thing configuration 

- Account Name (`accountName`) is your Login Name for the Telekom Kundencenter (registered email address) 
- Account Password (`accountPassword`) is the corresponding password.

The binding will do an automated login, receives the UID (`userId`) and stores this in the Thing configuration.
For security reasons the credentials will be automatically deleted from the thing configuration (replaced with '***') after the initial process.

## Receiver Standby Mode

The Media receiver has 3 different standby modes, which could be selected in the receiver's settings.

|Mode          |Description                                                                             |
|--------------|----------------------------------------------------------------------------------------|
|Standby       |Full standby - the receiver active all the time, sleeps when off and wakes up instantly.|
|Suspend/Resume|The receiver goes to sleep mode, but could be awaked by a Wake-on-LAN packet            |
|Shutdown      |Powering off will shutdown the receiver, can be awaked only with the power button       |

`Standby` provides the best results, because the binding could wake-up the receiver (Power On/Off).
`Suspend/Resume` would require a Wake-on-LAN, which could be done, but this is currently not implemented. 
`Shutdown` turns the receiver off, which requires a manual power-on.

There is no way to detect the "display status" of the receiver. 
The binding detects Power-Off with the MR401B/MR201 by listening to UPnP events, but can't verify the status when started.
You need to take care on the current status if you power on/off the receiver from scenes.
Check the current status before sending the POWER button, because POWER is a toggle, not ON or OFF (see sample rules).

## Thing Configuration

|Parameter       |Description                                                                                                     |
|----------------|----------------------------------------------------------------------------------------------------------------|
|accountName     |Login Name (email), should be the registered e-mail address for the Telekom Kundencenter                        |
|accountPassword |Account password (same as for the Kundencenter)                                                                 |
|userId          |The technical userId/UID required for the pairing process, see section "Generating userId"                      | 
|ipAddress       |IP address of the receiver, usually discovered by UPnP                                                          |
|port            |Port to reach the remote service, usually 8081 for the MR401/MR201 or 49152 for MR400/200                       |
|udn             |UPnP Unique Device Name - a hex ID, which includes the 12 digit MAC address at the end (parsed by the binding)  |

For textual configuration at least the `ipAddress`, `udn` and `userId` parameters are required.

## Channels

|Group   |Channel        |Item-Type|Description                                                               |
|--------|---------------|---------|--------------------------------------------------------------------------|
|control |power          |Switch   |Switching the channel simulates pressing the power button (same as sending 
"POWER" to the key channel). The receiver doesn't offer ON and OFF, but just toggles the power state.
For that it's tricky to ensure the power state. Maybe some future versions will use some kind of 
testing to determine the current state.                                                                       |
|        |channel        |Number   |Select program channel (outbound only, current channel is not available)  |
|        |player         |Player   |Send commands to the receiver - see below                                 |
|        |key            |String   |Send key code to the receiver (see code table below)                      |
|        |mute           |Switch   |Mute volume (mute the speaker)                                            |
|status  |playMode       |String   |Current play mode - this info is not reliable                             |
|        |channelCode    |Number  Â |The channel code from the EPG.                                            |
|program |title          |String   |Title of the running program or video being played                        |
|        |text           |String   |Some description (as reported by the receiver, could be empty)            |
|        |start          |DateTime |Time when the program started                                             |
|        |position       |Number   |Position in minutes within a movie.                                       |
|        |duration       |Number   |Remaining time in minutes, usually not updated for TV program             | 

Please note: Channels receiving event information get updated when changing the channel or playing a video.
There is no way to read the current status, therefore they don't get initialized on startup nor being updated in real-time.

The player channel supports the following actions:

|Channel |Command        |Description                       |
|--------|---------------|----------------------------------|
|player  |PLAY           |Start playing media               |
|        |PAUSE          |Pause player                      |
|        |NEXT           |Move to the next chapter          |
|        |PREVIOUS       |Move to the previous chapter      |
|        |FASTFORWARD    |Switch to forward mode            |
|        |REWIND         |Switch to rewind mode             |
|        |ON or OFF      |Toggle power - see notes on power |

## Supported Key Code (channel key)

| Key      | Description                                    |
| ---------|------------------------------------------------|
| POWER    | Power on/off the receiver (check standby mode) |
| 0..9     | Key 0..9                                       |
| SPACE    | Space key                                      |
| POUND    | # key                                          |
| START    | * key                                          |
| DELETE   | Delete key (text edit)                         |
| ENTER    | Enter/Select key                               |
| RED      | Special Actions: red                           |
| GREEN    | Special Actions: green                         |
| YELLOW   | Special Actions: yellow                        |
| BLUE     | Special Actions: blue                          |
| EPG      | Electronic Program Guide                       |
| OPTION   | Display options                                |
| SETTINGS | Display options                                |
| UP       | Up arrow                                       |
| DOWN     | Down arrow                                     |
| PGUP     | Page up                                        |
| PGDOWN   | Page down                                      |
| LEFT     | Left arrow                                     |
| RIGHT    | Right arrow                                    |
| OK       | OK button                                      |
| BACK     | Return to last menu                            |
| EXIT     | Exit menu                                      |
| MENU     | Menu                                           |
| INFO     | Display information                            |
| FAV      | Display favorites                              |
| VOLUP    | Volume up                                      |
| VOLDOWN  | Volume down                                    |
| MUTE     | Mute speakers                                  |
| CHUP     | Channel up                                     |
| CHDOWN   | Channel down                                   |
| PLAY     | Play                                           | 
| PAUSE    | Play                                           | 
| STOP     | Stop playing                                   |
| RECORD   | Start recording                                |
| REWIND   | Rewind                                         |
| FORWARD  | Forward                                        |
| LASTCH   | Last channel                                   |
| NEXTCH   | Next channel                                   |
| LASTCHAP | Last chapter                                   |
| NEXTCHAP | Next chapter                                   |
| PAIR     | Re-pair with the receiver                      |

In addition you could send any key code in the 0xHHHH format., refer to
[Key Codes for Magenta/Huawei Media Receiver](http://support.huawei.com/hedex/pages/DOC1100366313CEH0713H/01/DOC1100366313CEH0713H/01/resources/dsv_hdx_idp/DSV/en/en-us_topic_0094619112.html)


## Full Configuraton Example

### magentatv.things

```
Thing magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx "MagentaTV" [
udn="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
ipAddress="xxx.xxx.xxx.xxx", 
accountName="xxxxxx.xxxx@t-online.de",
accountPassword="xxxxxxxxxx"
]
```

### magentatv.items

```
# MagentaTV Control
Switch MagentaTV_Power        "Power"        {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:control#power"}
Number MagentaTV_Channel      "Channel"      {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:status#channel"}
String MagentaTV_Key          "Key"          {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:control#key"}

# MagentaTV Program Information
String MagentaTV_ProgTitle   "Program Title" {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:program#title"}
String MagentaTV_ProgDescr   "Description"   {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:program#text"}
String MagentaTV_ProgStart   "Start Time"    {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:program#tart"}
String MagentaTV_ProgDur     "Duration"      {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:program#duration"}
String MagentaTV_ProgPos     "Position"      {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:program#position"}

# MagentaTV Play Status
Number MagentaTV_ChCode    "Channel Code"    {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:status#channelCode"}
String MagentaTV_PlayMode  "Play Mode"       {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:status#playMode"}
String MagentaTV_RunStatus "Run Status"      {channel="magentatv:receiver:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:status#runStatus"}
```

### sitemap

```
please contribute an example
```

### magentatv.rules

Due to the fact the POWER is a toggle button and the binding cannot detect the current status, which could lead into the situation that you want to power on the receiver as part of a scene, but due to the fact that it is already ON you switch it off.

Beginning with models 401/201 and new the binding is able to detect the Power-OFF condition, which can be used in a rule to improve this situation

```
        if (MagentaTV_Power.state != ON) {
            sendCommand(MagentaTV_Power, ON)
        }
```

to switch it ON and 

```
        if (MagentaTV_Power.state != OFF) {
            sendCommand(MagentaTV_Power, OFF)
        }
```

to switch it off.

After an openHAB restart you need to make sure that OH and receiver are in sync, because the binding can't read the power status at startup.

